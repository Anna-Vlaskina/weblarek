(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const v of a.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&n(v)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}})();class I{constructor(t,e){this.events=e,this.events=e,this.arrayProducts=t}arrayProducts;cardProduct;setArrayProducts(t){const e=[...this.arrayProducts];this.arrayProducts=[...t],this.events?.emit("products:changed",{oldProducts:e,newProducts:this.arrayProducts,action:"replace"})}getArrayProducts(){return[...this.arrayProducts]}getProduct(t){const e=this.arrayProducts.find(n=>n.id===t);if(!e)throw new Error(`Товар с ID ${t} не найден`);return{id:e.id,description:e.description,image:e.image,title:e.title,category:e.category,price:e.price}}setProductForDisplay(t){const e=this.cardProduct?{...this.cardProduct}:void 0;this.cardProduct={...t},this.events.emit("product:display:changed",{oldProduct:e,newProduct:this.cardProduct})}getProductForDisplay(){return this.cardProduct}}class F{constructor(t=[],e){this.events=e,this.arrayProducts=t,this.events.emit("basket:initialized",{products:this.getArrayBasket(),totalPrice:this.getTotalPrice(),itemsCount:this.getItemsCount()})}arrayProducts;getArrayBasket(){return[...this.arrayProducts]}addProduct(t){const e=this.getArrayBasket();return this.arrayProducts=this.arrayProducts.concat(t),this.events.emit("basket:product:added",{product:t,products:this.getArrayBasket(),totalPrice:this.getTotalPrice(),itemsCount:this.getItemsCount(),oldProducts:e}),this.arrayProducts}delProduct(t){const e=this.getArrayBasket(),n=this.arrayProducts.find(o=>o.id===t);return this.arrayProducts=this.arrayProducts.filter(o=>o.id!==t),n&&this.events.emit("basket:product:removed",{product:n,productId:t,products:this.getArrayBasket(),totalPrice:this.getTotalPrice(),itemsCount:this.getItemsCount(),oldProducts:e}),this.arrayProducts}clearBasket(){const t=this.getArrayBasket();this.arrayProducts=[],this.events.emit("basket:cleared",{oldProducts:t,products:this.getArrayBasket(),totalPrice:this.getTotalPrice(),itemsCount:this.getItemsCount()})}getTotalPrice(){return this.arrayProducts.reduce((e,n)=>e+(n.price??0),0)}getItemsCount(){return this.arrayProducts.length}hasProduct(t){return this.arrayProducts.some(e=>e.id===t)}}class O{constructor(t,e){this.events=e,this.payment=t.payment,this.email=t.email,this.phone=t.phone,this.address=t.address,this.events.emit("buyer:initialized",{buyerData:this.getBuyerData()})}payment;email;phone;address;saveOrderData(t){const e=this.getBuyerData();this.payment=t.payment,this.email=t.email||"",this.phone=t.phone||"",this.address=t.address,this.events.emit("buyer:data:saved",{oldData:e,newData:this.getBuyerData(),changes:this.getChangedFields(e,t)})}getBuyerData(){return{payment:this.payment,email:this.email,phone:this.phone,address:this.address}}clearBuyerData(){const t=this.getBuyerData();this.payment="",this.email="",this.phone="",this.address="",this.events.emit("buyer:data:cleared",{oldData:t,newData:this.getBuyerData()})}validateOrder(){const t=[];this.payment||t.push("Выберите способ оплаты"),this.address?.trim()||t.push("Введите адрес доставки");const e=t.length===0;return this.events.emit("buyer:validation:checked:order",{isValid:e,buyerData:this.getBuyerData(),validationDetails:{hasPayment:!!this.payment,hasAddress:!!this.address.trim()}}),{isValid:e,errors:t}}validateContacts(){const t=[];this.email?.trim()||t.push("Введите email"),this.phone?.trim()||t.push("Введите телефон");const e=t.length===0;return this.events.emit("buyer:validation:checked:contacts",{isValid:e,buyerData:this.getBuyerData(),validationDetails:{hasEmail:!!this.email.trim(),hasPhone:!!this.phone.trim()}}),{isValid:e,errors:t}}getChangedFields(t,e){const n=[];return t.payment!==e.payment&&n.push("payment"),t.email!==e.email&&n.push("email"),t.phone!==e.phone&&n.push("phone"),t.address!==e.address&&n.push("address"),n}}class B{baseUrl;options;constructor(t,e={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...e.headers??{}}}}handleResponse(t){return t.ok?t.json():t.json().then(e=>Promise.reject(e.error??t.statusText))}get(t){return fetch(this.baseUrl+t,{...this.options,method:"GET"}).then(this.handleResponse)}post(t,e,n="POST"){return fetch(this.baseUrl+t,{...this.options,method:n,body:JSON.stringify(e)}).then(this.handleResponse)}}class x{instanceApi;constructor(t){this.instanceApi=t}get(t){return this.instanceApi.get(t)}post(t,e,n){return this.instanceApi.post(t,e,n)}}const A="https://larek-api.nomoreparties.co/api/weblarek",L="https://larek-api.nomoreparties.co/content/weblarek",y={"софт-скил":"card__category_soft","хард-скил":"card__category_hard",кнопка:"card__category_button",дополнительное:"card__category_additional",другое:"card__category_other"};function D(s){return typeof s=="string"&&s.length>1}function f(s,t=document){if(D(s))return Array.from(t.querySelectorAll(s));if(s instanceof NodeList)return Array.from(s);if(Array.isArray(s))return s;throw new Error("Unknown selector element")}function r(s,t){if(D(s)){const e=f(s,t);if(e.length>1&&console.warn(`selector ${s} return more then one element`),e.length===0)throw new Error(`selector ${s} return nothing`);return e.pop()}if(s instanceof HTMLElement)return s;throw new Error("Unknown selector element")}function p(s){const e=r(s).content.firstElementChild;if(!e)throw new Error("Template content has no elements.");return e.cloneNode(!0)}class g{constructor(t){this.container=t}toggleClass(t,e,n){t.classList.toggle(e,n)}setText(t,e){t&&(t.textContent=String(e))}setDisabled(t,e){t&&(e?t.setAttribute("disabled","disabled"):t.removeAttribute("disabled"))}setHidden(t){t.style.display="none"}setVisible(t){t.style.removeProperty("display")}setImage(t,e,n){t&&(t.src=e,n&&(t.alt=n))}render(t){return Object.assign(this,t??{}),this.container}}class k extends g{titleElement;priceElement;constructor(t){super(t),this.titleElement=r(".card__title",this.container),this.priceElement=r(".card__price",this.container)}set title(t){this.setText(this.titleElement,t)}set price(t){this.setText(this.priceElement,`${t} синапсов`),t===null&&this.setText(this.priceElement,"Бесценно")}}class $ extends k{categoryElement;imageElement;constructor(t,e){super(t),this.categoryElement=r(".card__category",this.container),this.imageElement=r(".card__image",this.container),e?.onClick&&this.container.addEventListener("click",e.onClick)}set category(t){this.categoryElement.textContent=t;for(const e in y)this.categoryElement.classList.toggle(y[e],e===t)}set image(t){const e=`${L}${t}`;this.setImage(this.imageElement,e,this.title)}}class M extends g{constructor(t,e){super(e),this.events=t,this.basketButton=r(".header__basket",this.container),this.counterElement=r(".header__basket-counter",this.container),this.basketButton.addEventListener("click",()=>{this.events.emit("basket:open")})}basketButton;counterElement;set counter(t){this.counterElement.textContent=String(t)}}class S extends g{constructor(t,e){super(t),this.events=e,this.catalogElement=r(".gallery",this.container)}catalogElement;set catalog(t){this.catalogElement.innerHTML="",t.forEach(e=>{this.catalogElement.appendChild(e)})}}class U extends g{constructor(t,e){super(t),this.events=e,this.modalButton=r(".modal__close",this.container),this.contentElement=r(".modal__content",this.container),this.modalButton.addEventListener("click",()=>{this.close()}),this.container.addEventListener("click",n=>{n.target===this.container&&this.close()})}modalButton;contentElement;set content(t){this.contentElement.innerHTML="",this.contentElement.appendChild(t)}open(){this.container.classList.add("modal_active")}close(){this.container.classList.remove("modal_active"),this.events?.emit("modal:close")}openWithContent(t){this.content=t,this.open()}}class V extends g{constructor(t,e){super(t),this.events=e,this.titleElement=r(".order-success__title",this.container),this.priceElement=r(".order-success__description",this.container),this.successButton=r(".order-success__close",this.container),this.successButton.addEventListener("click",()=>{this.events.emit("success:close")})}titleElement;priceElement;successButton;set price(t){this.priceElement.textContent=t}}class R{_events;constructor(){this._events=new Map}on(t,e){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(e)}off(t,e){this._events.has(t)&&(this._events.get(t).delete(e),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,e){this._events.forEach((n,o)=>{o==="*"&&n.forEach(a=>a({eventName:t,data:e})),(o instanceof RegExp&&o.test(t)||o===t)&&n.forEach(a=>a(e))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,e){return(n={})=>{this.emit(t,{...n||{},...e||{}})}}}class j extends k{imageElement;categoryElement;descriptionElement;buttonElement;constructor(t,e){super(t),this.imageElement=r(".card__image",this.container),this.categoryElement=r(".card__category",this.container),this.descriptionElement=r(".card__text",this.container),this.buttonElement=r(".card__button",this.container),e?.onClick&&this.buttonElement.addEventListener("click",e.onClick)}set category(t){this.categoryElement.textContent=t;for(const e in y)this.categoryElement.classList.toggle(y[e],e===t)}set image(t){const e=`${L}${t}`;this.setImage(this.imageElement,e,this.title)}set description(t){this.setText(this.descriptionElement,t)}updateButtonState(t,e){e?t?(this.buttonElement.textContent="Удалить из корзины",this.buttonElement.disabled=!1):(this.buttonElement.textContent="Купить",this.buttonElement.disabled=!1):(this.buttonElement.textContent="Недоступно",this.buttonElement.disabled=!0)}}class H extends g{constructor(t,e){super(t),this.events=e,this.titleElement=r(".modal__title",this.container),this.productsElement=r(".basket__list",this.container),this.basketButton=r(".basket__button",this.container),this.priceElement=r(".basket__price",this.container),this.basketButton&&this.basketButton.addEventListener("click",()=>{e.emit("order:open")})}titleElement;productsElement;basketButton;priceElement;set products(t){if(this.productsElement.innerHTML="",this.basketButton&&(this.basketButton.disabled=t.length===0),t.length===0){const e=document.createElement("div");e.className="basket__empty",e.textContent="Корзина пуста",this.productsElement.appendChild(e)}else t.forEach(e=>{this.productsElement.appendChild(e)})}set price(t){this.priceElement.textContent=`${t} синапсов`}}class W extends k{indexElement;buttonElement;constructor(t,e){super(t),this.indexElement=r(".basket__item-index",this.container),this.buttonElement=r(".basket__item-delete",this.container),e?.onClick&&this.buttonElement.addEventListener("click",e.onClick)}set index(t){this.setText(this.indexElement,String(t))}}class T extends g{constructor(t,e){super(t),this.events=e,this.submitElement=r("button[type=submit]",this.container),this.errorsElement=r(".form__errors",this.container),this.container.addEventListener("submit",n=>{n.preventDefault(),this.events.emit(`${this.container.getAttribute("name")}:form:submit`)})}submitElement;errorsElement;set errors(t){this.setText(this.errorsElement,t)}set valid(t){this.submitElement.disabled=!t}}class z extends T{constructor(t,e){super(t,e),this.events=e,this.titleForm=r("h2.modal__title",this.container),this.buttonsForm=f(".button_alt",this.container),this.titleLabelElement=r(".form__label",this.container),this.inputElement=r(".form__input",this.container),this.buttonsForm.forEach(n=>{n.addEventListener("click",o=>{o.preventDefault(),this.events?.emit("order:payment:change",{payment:n.name})})}),this.inputElement.addEventListener("input",n=>{n.preventDefault(),this.events?.emit("order:address:change",{address:this.inputElement.value})})}titleForm;buttonsForm;titleLabelElement;inputElement;set payment(t){this.buttonsForm.forEach(e=>{e.classList.toggle("button_alt-active",e.name===t)})}set address(t){this.inputElement.value=t}}class q extends T{constructor(t,e){super(t,e),this.events=e,this.titleLabelElement=f(".form__label",this.container),this.inputElements=f(".form__input",this.container),this.inputElements.forEach(n=>{n.addEventListener("input",o=>{o.preventDefault(),console.log("Input change:",n.name,n.value);const a={};n.name==="email"&&(a.email=n.value),n.name==="phone"&&(a.phone=n.value),this.events?.emit("contacts:input:change",a)})})}titleLabelElement;inputElements;set email(t){const e=this.inputElements.find(n=>n.name==="email");e&&(e.value=t)}set phone(t){const e=this.inputElements.find(n=>n.name==="phone");e&&(e.value=t)}}const i=new R;i.onAll(({eventName:s,data:t})=>{console.log(s,t)});const c={headerContainer:r(".header"),galleryContainer:r(".page__wrapper"),modalContainer:r(".modal"),success:r("#success"),cardCatalog:r("#card-catalog"),preview:r("#card-preview"),cardBasket:r("#card-basket"),basket:r("#basket"),order:r("#order"),contacts:r("#contacts")},G=new S(c.galleryContainer),h=new U(c.modalContainer,i),_=new H(p(c.basket),i),J=new M(i,c.headerContainer),l=new F([],i),d=new O({payment:"",email:"",phone:"",address:""},i),m=new z(p(c.order),i),u=new q(p(c.contacts),i),w=new V(p(c.success),i);let E=new I([],i);(async function(){const t=await new x(new B(A)).get("/product/");E.setArrayProducts(t.items)})();function b(){K(),N()}function K(){J.counter=l.getItemsCount()}function N(){const s=l.getArrayBasket(),t=l.getTotalPrice()||0;_.price=t;const e=s.map((n,o)=>new W(p(c.cardBasket),{onClick:()=>i.emit("basket:item:delete",n)}).render({...n,index:o+1}));_.products=e}i.on("products:changed",()=>{if(!E)return;const t=E.getArrayProducts().map(e=>new $(p(c.cardCatalog),{onClick:()=>i.emit("card:click",e)}).render(e));G.catalog=t});i.on("card:click",s=>{E.setProductForDisplay(s);const e=new j(p(c.preview),{onClick:()=>i.emit("preview:button:click",s)}).render(s);h.openWithContent(e)});i.on("preview:button:click",s=>{l.hasProduct(s.id)?l.delProduct(s.id):l.addProduct(s),i.emit("modal:close")});i.on("basket:item:delete",s=>{l.delProduct(s.id)});i.on("basket:product:added",b);i.on("basket:product:removed",b);i.on("basket:cleared",b);i.on("basket:open",()=>{h.openWithContent(_.render())});i.on("order:open",()=>{if(l.getItemsCount()>0){const s=d.getBuyerData();m.payment=s.payment,m.address=s.address,h.openWithContent(m.render())}});i.on("order:payment:change",s=>{d.saveOrderData({...d.getBuyerData(),payment:s.payment}),m.payment=s.payment,P()});i.on("order:address:change",s=>{d.saveOrderData({...d.getBuyerData(),address:s.address}),m.address=s.address,P()});i.on("contacts:open",()=>{const s=d.getBuyerData();u.email=s.email,u.phone=s.phone;const t=u.render();h.content=t,C()});i.on("contacts:input:change",s=>{const t=d.getBuyerData();d.saveOrderData({...t,...s});const e=u.render();h.content=e,C()});i.on("order:form:submit",()=>{P()&&i.emit("contacts:open")});i.on("contacts:form:submit",async()=>{C()&&await Q()});async function Q(){try{const s=d.getBuyerData(),t={payment:s.payment,address:s.address,email:s.email,phone:s.phone,items:l.getArrayBasket().map(o=>o.id),total:l.getTotalPrice()},n=await new x(new B(A)).post("/order",t);i.emit("order:success",n)}catch(s){console.error("Ошибка при оформлении заказа:",s);const t=u.render();u.errors="Произошла ошибка при оформлении заказа. Попробуйте еще раз.",h.content=t}}i.on("order:success",s=>{l.clearBasket(),d.clearBuyerData(),w.price=`Списано ${s?.total||0} синапсов`,h.content=w.render(),c.modalContainer.classList.add("modal_active")});i.on("success:close",()=>{h.close()});i.on("modal:close",()=>{h.close()});c.modalContainer.addEventListener("click",s=>{s.target===c.modalContainer&&i.emit("modal:close")});function P(){const s=d.validateOrder();return m.valid=s.isValid,m.errors=s.errors.join("; "),s.isValid}function C(){const s=d.validateContacts();return u.valid=s.isValid,u.errors=s.errors.join("; "),s.isValid}b();
